<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>TEXBOY 64 - Perfect Fit Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&display=swap');
        body { margin: 0; background: #88aabb; overflow: hidden; font-family: 'Roboto Mono', monospace; }
        canvas { display: block; image-rendering: pixelated; }

        /* UI ADJUSTMENTS */
        #config-modal {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            width: 95%; max-width: 450px; background: #121620;
            border: 4px solid #557799; padding: 15px;
            color: #fff; z-index: 2000;
            opacity: 0; pointer-events: none; box-shadow: 20px 20px 0px rgba(0,0,0,0.4);
            display: flex; flex-direction: column;
        }
        @media (min-width: 768px) {
            #config-modal { padding: 25px; width: 90%; transform: translate(-50%, -50%) scale(1); }
        }

        #ui-bar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; align-items: center; gap: 10px;
            z-index: 1000; width: 95%; justify-content: center;
            max-width: 600px;
        }
        .btn-main {
            padding: 18px 20px; font-size: 16px; cursor: pointer;
            flex: 1; max-width: 400px;
            background: #ffffff; color: #333; border: 4px solid #557799;
            font-weight: 900; text-transform: uppercase; box-shadow: 8px 8px 0px #334455;
            white-space: nowrap; text-align: center;
        }
        .btn-main:active, .btn-confirm:active { transform: translate(4px, 4px); box-shadow: 2px 2px 0px #334455; }

        .btn-gear {
            width: 65px; height: 65px; min-width: 65px;
            display: flex; align-items: center; justify-content: center;
            background: #cbd5e1; border: 4px solid #557799; cursor: pointer; box-shadow: 8px 8px 0px #334455;
        }
        .pixel-gear { width: 28px; height: 28px; background: #334455; position: relative; }
        .pixel-gear::before, .pixel-gear::after { content: ''; position: absolute; inset: 0; background: inherit; transform: rotate(45deg); }
        .pixel-gear-inner { position: absolute; inset: 8px; background: #cbd5e1; z-index: 10; }

        .btn-confirm {
            margin-top: 15px; width: 100%; padding: 15px;
            background: #4ade80; color: #064e3b; border: 3px solid #064e3b;
            font-weight: 900; text-transform: uppercase; cursor: pointer;
            box-shadow: 6px 6px 0px #065f46; font-family: 'Roboto Mono', monospace;
            font-size: 16px;
        }

        input, textarea, select { background: #000; border: 2px solid #445566; color: #0f0; width: 100%; padding: 10px; margin-bottom: 10px; font-size: 16px; }
        label { font-size: 12px; color: #88aabb; font-weight: bold; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

<div id="config-modal">
    <div class="flex justify-between items-center mb-4 border-b-2 border-gray-700 pb-2">
        <h2 class="text-sm font-bold text-blue-400 uppercase">Texboy_64 // Setup</h2>
    </div>
    <label>Prêmio:</label>
    <input type="text" id="input-premio" value="Cesta Especial" oninput="updateRaffle()">
    <label>Nomes:</label>
    <textarea id="input-nomes" rows="6" oninput="processNames()">Rosemeire, Denise, Roseli, Silvana, Clarice, Mônica, Rosângela, Cleuza, Mirtes, Margarida, Zulmira, Raquel, Norma, Noêmia, Antônia, Alessandra, Salete, Marlene, Rosana, Elizabeth</textarea>
    <div class="flex gap-4">
        <div class="w-1/2">
            <label>Sorteio:</label>
            <select id="select-mode" onchange="toggleManualMode()">
                <option value="random">RANDOM</option>
                <option value="manual">INJECT</option>
            </select>
        </div>
        <div id="manual-winner-area" class="w-1/2 hidden">
            <label class="text-yellow-500">Alvo:</label>
            <select id="select-winner" onchange="updateRaffle()"></select>
        </div>
    </div>
    <button onclick="toggleModal()" class="btn-confirm">SALVAR & FECHAR</button>
</div>

<div id="ui-bar">
    <button onclick="toggleFlap()" id="btn-action" class="btn-main">Revelar Resultado</button>
    <button onclick="toggleModal()" class="btn-gear"><div class="pixel-gear" id="gear-icon"><div class="pixel-gear-inner"></div></div></button>
</div>

<script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.150.1/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.150.1/examples/jsm/" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    let state = { names: [], winner: "", prize: "", isOpen: false, isAnimating: false, isModalOpen: false };
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x88aabb);

    const camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.1, 1000);

    // --- FUNÇÃO DE FIT DE CÂMERA ---
    function fitCameraToSelection(camera, objectWidth, objectHeight) {
        const aspect = window.innerWidth / window.innerHeight;
        const fovRad = camera.fov * (Math.PI / 180);

        let distance;
        if (aspect < 1) {
            // Mobile: Foca na largura com margem generosa (1.3x)
            distance = (objectWidth / aspect) / (2 * Math.tan(fovRad / 2)) * 1.3;
        } else {
            // Desktop: Foca na altura
            const distHeight = objectHeight / (2 * Math.tan(fovRad / 2));
            const distWidth = objectWidth / (2 * Math.tan(fovRad / 2) * aspect);
            distance = Math.max(distHeight, distWidth) * 1.15;
        }
        return distance;
    }

    const renderer = new THREE.WebGLRenderer({ antialias: false });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio * 0.85);
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    scene.add(new THREE.AmbientLight(0xffffff, 1.4));

    // --- TEXTURE BUFFERS ---
    const fCanv = document.createElement('canvas'); fCanv.width = 1024; fCanv.height = 2048;
    const bCanv = document.createElement('canvas'); bCanv.width = 1024; bCanv.height = 2048;
    const ffCanv = document.createElement('canvas'); ffCanv.width = 1024; ffCanv.height = 400;
    const fbCanv = document.createElement('canvas'); fbCanv.width = 1024; fbCanv.height = 400;

    const fTex = new THREE.CanvasTexture(fCanv); const bTex = new THREE.CanvasTexture(bCanv);
    const ffTex = new THREE.CanvasTexture(ffCanv); const fbTex = new THREE.CanvasTexture(fbCanv);
    [fTex, bTex, ffTex, fbTex].forEach(t => t.magFilter = t.minFilter = THREE.NearestFilter);

    function drawPaperBase(ctx, w, h, isBack = false) {
        ctx.fillStyle = isBack ? '#f0ebe4' : '#ffffff'; ctx.fillRect(0,0,w,h);
        ctx.globalAlpha = 0.08;
        for(let i=0; i<6000; i++) {
            ctx.fillStyle = Math.random() > 0.5 ? '#000' : '#fff';
            ctx.fillRect(Math.random()*w, Math.random()*h, 2, 2);
        }
        ctx.globalAlpha = 1.0;
    }

    window.updateRaffleTextures = function() {
        const fctx = fCanv.getContext('2d'); drawPaperBase(fctx, 1024, 2048);
        let fGrad = fctx.createLinearGradient(0,0,0,320);
        fGrad.addColorStop(0, 'rgba(0,0,0,0.9)'); fGrad.addColorStop(1, 'rgba(0,0,0,0)');
        fctx.fillStyle = fGrad; fctx.fillRect(0,0,1024,320);

        fctx.textAlign = 'center'; fctx.fillStyle = '#ff0000'; fctx.font = 'bold 110px Arial Black';
        fctx.fillText(state.winner.toUpperCase(), 512, 110);

        fctx.fillStyle = '#333'; fctx.font = 'bold 180px Impact'; fctx.fillText('CARTELA', 512, 450);
        fctx.font = 'bold 90px Impact'; fctx.fillText(`COM ${state.names.length} NOMES`, 512, 580);

        fctx.textAlign = 'left'; fctx.strokeStyle = '#000'; fctx.lineWidth = 10; fctx.font = 'bold 65px Arial';
        fctx.fillText(`PRÊMIO: ${state.prize.toUpperCase()}`, 80, 750);
        fctx.beginPath(); fctx.moveTo(380,750); fctx.lineTo(940,750); fctx.stroke();

        fctx.strokeStyle = '#000'; fctx.lineWidth = 4; fctx.textAlign = 'center';
        state.names.forEach((n, i) => {
            let col = i % 5; let row = Math.floor(i / 5);
            let x = 80 + col*172; let y = 920 + row*105;
            if(y < 1950) {
                fctx.strokeRect(x,y,172,105);
                let fontSize = 28;
                if(n.length > 8) fontSize = 22;
                if(n.length > 12) fontSize = 18;
                fctx.font = `900 ${fontSize}px Arial Black`;
                fctx.fillStyle = '#000';
                fctx.fillText(n.toUpperCase(), x+86, y+62);
            }
        });

        const bctx = bCanv.getContext('2d'); drawPaperBase(bctx, 1024, 2048, true);
        bctx.save(); bctx.translate(1024, 0); bctx.scale(-1, 1); bctx.globalAlpha = 0.3;
        bctx.fillStyle = '#2c3e50'; bctx.font = 'bold 180px Impact'; bctx.fillText('CARTELA', 512, 450);
        state.names.forEach((n, i) => {
            let col = i % 5; let row = Math.floor(i / 5);
            let x = 80 + col*172; let y = 920 + row*105;
            if(y < 1950) bctx.strokeRect(x,y,172,105);
        });
        bctx.restore();
        bctx.textAlign = 'right'; bctx.fillStyle = 'rgba(200,30,30,0.85)'; bctx.font = 'bold 70px Courier New'; bctx.fillText('№ 000'+state.names.length+'-A', 950, 130);
        bctx.textAlign = 'left'; bctx.fillStyle = '#666'; bctx.font = 'bold 22px Arial'; bctx.fillText('REGULAMENTO TEXBOY_OS:', 60, 1600);
        bctx.fillStyle = '#999'; for(let i=0; i<6; i++) bctx.fillRect(60, 1640 + (i*20), 900 - (Math.random()*150), 6);
        bctx.fillStyle = '#000'; for(let i=0; i<40; i++) bctx.fillRect(280 + (i*14), 1800, Math.random()*12+4, 110);
        bctx.textAlign = 'center'; bctx.fillStyle = '#2c3e50'; bctx.font = '900 110px Impact'; bctx.fillText('TEXBOY', 512, 2010);

        const ffctx = ffCanv.getContext('2d'); drawPaperBase(ffctx, 1024, 400);
        ffctx.fillStyle = '#111'; ffctx.fillRect(200,0,624,400);
        let ffG = ffctx.createLinearGradient(0,250,0,400); ffG.addColorStop(0,'transparent'); ffG.addColorStop(1,'rgba(0,0,0,0.75)');
        ffctx.fillStyle = ffG; ffctx.fillRect(0,250,1024,150);
        const fbctx = fbCanv.getContext('2d'); drawPaperBase(fbctx, 1024, 400, true);
        let fbG = fbctx.createLinearGradient(0,0,0,250); fbG.addColorStop(0,'rgba(0,0,0,0.9)'); fbG.addColorStop(1,'transparent');
        fbctx.fillStyle = fbG; fbctx.fillRect(0,0,1024,250);

        [fTex, bTex, ffTex, fbTex].forEach(t => t.needsUpdate = true);
    }

    const chromeC = document.createElement('canvas'); chromeC.width = 128; chromeC.height = 128;
    const cctx = chromeC.getContext('2d');
    const cGrad = cctx.createRadialGradient(40,40,5,64,64,60);
    cGrad.addColorStop(0,'#fff'); cGrad.addColorStop(0.3,'#aaa'); cGrad.addColorStop(1,'#111');
    cctx.fillStyle = cGrad; cctx.fillRect(0,0,128,128);
    const chromeMat = new THREE.MeshMatcapMaterial({ matcap: new THREE.CanvasTexture(chromeC) });

    const raffleGroup = new THREE.Group(); scene.add(raffleGroup);
    const card = new THREE.Mesh(new THREE.BoxGeometry(4.0, 7.0, 0.06), [
        new THREE.MeshStandardMaterial({color:0xdddddd}), new THREE.MeshStandardMaterial({color:0xdddddd}),
        new THREE.MeshStandardMaterial({color:0xdddddd}), new THREE.MeshStandardMaterial({color:0xdddddd}),
        new THREE.MeshStandardMaterial({map:fTex}), new THREE.MeshStandardMaterial({map:bTex})
    ]);
    raffleGroup.add(card);

    const flapPivot = new THREE.Group(); flapPivot.position.set(0, 3.5, 0.06); raffleGroup.add(flapPivot);
    const foldMesh = new THREE.Mesh(new THREE.BoxGeometry(4.0, 0.8, 0.05), [
        new THREE.MeshStandardMaterial({color:0xdddddd}), new THREE.MeshStandardMaterial({color:0xdddddd}),
        new THREE.MeshStandardMaterial({color:0xdddddd}), new THREE.MeshStandardMaterial({color:0xdddddd}),
        new THREE.MeshStandardMaterial({map:ffTex}), new THREE.MeshStandardMaterial({map:fbTex})
    ]);
    foldMesh.position.y = -0.4; flapPivot.add(foldMesh);
    const r1 = new THREE.Mesh(new THREE.SphereGeometry(0.09, 16, 16), chromeMat);
    r1.scale.set(1, 1, 0.4); r1.position.set(-1.25, 0, 0.04); foldMesh.add(r1);
    const r2 = r1.clone(); r2.position.set(1.25, 0, 0.04); foldMesh.add(r2);

    window.processNames = function() {
        state.names = document.getElementById('input-nomes').value.split(/,|\n/).map(n => n.trim()).filter(n => n !== "");
        const select = document.getElementById('select-winner'); select.innerHTML = "";
        state.names.forEach(n => { let o = document.createElement('option'); o.value = n; o.text = n; select.add(o); });
        updateRaffle();
    }
    window.toggleManualMode = function() {
        document.getElementById('manual-winner-area').classList.toggle('hidden', document.getElementById('select-mode').value === 'random');
        updateRaffle();
    }
    window.updateRaffle = function() {
        state.prize = document.getElementById('input-premio').value;
        const mode = document.getElementById('select-mode').value;
        state.winner = mode === 'random' ? (state.names[Math.floor(Math.random() * state.names.length)] || "???") : (document.getElementById('select-winner').value || "???");
        updateRaffleTextures();
    }
    window.toggleModal = function() {
        const modal = document.getElementById('config-modal');
        state.isModalOpen = !state.isModalOpen;
        gsap.to(modal, { opacity: state.isModalOpen ? 1 : 0, scale: state.isModalOpen ? 1 : 0.95, pointerEvents: state.isModalOpen ? 'auto' : 'none', duration: 0.3 });
        gsap.to("#gear-icon", { rotation: state.isModalOpen ? 90 : 0, duration: 0.4 });
    }

    // --- CORREÇÃO FINAL V5: ZOOM + ALTURA ADAPTATIVA ---
    window.toggleFlap = function() {
        if (state.isAnimating) return; state.isAnimating = true;

        const isMobile = window.innerWidth < 768;

        // Definição de alvos
        let targetZ, targetY, focusY;

        if (isMobile) {
            // Mobile: Zoom calculado para caber a largura, mas baixamos a câmera (Y=1.5)
            // para olhar mais de frente e centralizar o nome, evitando o corte superior.
            targetZ = fitCameraToSelection(camera, 4.2, 2.0);
            targetY = 1.8; // Câmera mais baixa
            focusY = 2.5;  // Foco no terço superior da rifa (onde está o nome)
        } else {
            // Desktop: Padrão
            targetZ = 2.5;
            targetY = 3.2;
            focusY = 3.2;
        }

        const tl = gsap.timeline({ onComplete: () => { state.isAnimating = false; } });
        if (!state.isOpen) {
            controls.enabled = false; document.getElementById('btn-action').innerText = "Fechar Rifa";

            // Movemos a câmera e também o TARGET do controle para centralizar o nome corretamente
            tl.to(camera.position, { x: 0, y: targetY, z: targetZ, duration: 1.2, ease: "power2.inOut" }, 0);
            tl.to(controls.target, { x: 0, y: focusY, z: 0, duration: 1.2, ease: "power2.inOut" }, 0);

            tl.to(flapPivot.rotation, { x: -2.3, duration: 1.0, ease: "back.out(1.2)" }, 0.4);
        } else {
            document.getElementById('btn-action').innerText = "Abrir Rifa";
            const returnZ = fitCameraToSelection(camera, 4.5, 7.0);

            tl.to(camera.position, { x: 0, y: 1.0, z: returnZ, duration: 1.0, ease: "power2.inOut" }, 0);
            tl.to(controls.target, { x: 0, y: 0, z: 0, duration: 1.0, ease: "power2.inOut", onComplete: () => { controls.enabled = true; } }, 0);
            tl.to(flapPivot.rotation, { x: 0, duration: 0.7 }, 0);
        }
        state.isOpen = !state.isOpen;
    }

    processNames();

    function enforceInitialFit() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);

        const bestZ = fitCameraToSelection(camera, 4.5, 7.0);
        camera.position.set(0, 1.0, bestZ);
        controls.target.set(0, 0, 0);
        controls.update();
    }

    enforceInitialFit();
    setTimeout(enforceInitialFit, 100);

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        if(!state.isOpen && !state.isAnimating) {
            raffleGroup.rotation.y = Math.sin(Date.now() * 0.001) * 0.06;
        }
        renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
        if(!state.isOpen && !state.isAnimating) {
            enforceInitialFit();
        } else {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    });
</script>
</body>
</html>
